<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa Interativo de Atuação Preventiva</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Custom Scrollbar similar to the React version */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background-color: #94a3b8;
        }
        
        /* Animation utilities */
        .fade-in {
            animation: fadeIn 0.2s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .pulsing {
            animation: pulse-ring 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse-ring {
            0%, 100% { opacity: 1; }
            50% { opacity: .5; }
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 font-sans h-screen flex flex-col overflow-hidden">

    <!-- Header -->
    <header class="flex-none bg-white p-4 border-b border-slate-200 shadow-sm z-20">
        <div class="flex flex-col md:flex-row justify-between items-center gap-4">
            <div class="flex items-center gap-3">
                <!-- Botão Voltar -->
                <a href="index.html" class="bg-slate-100 hover:bg-slate-200 p-2 rounded-lg text-slate-600 transition-colors" title="Voltar ao Menu">
                    <i data-lucide="arrow-left" class="w-6 h-6"></i>
                </a>

                <div class="bg-blue-600 p-2 rounded-lg text-white">
                    <i data-lucide="settings" class="w-6 h-6"></i>
                </div>
                <div>
                    <h1 class="text-xl font-bold text-slate-800">Mapa Interativo de Atuação Preventiva</h1>
                    <p class="text-slate-500 text-xs">Clique no catálogo à direita para destacar uma atividade no mapa</p>
                </div>
            </div>
            
            <div class="flex gap-2">
                <!-- Shift Filter -->
                <div class="flex items-center gap-2 bg-slate-100 px-3 py-1.5 rounded-lg border border-slate-200">
                    <i data-lucide="filter" class="w-4 h-4 text-slate-500"></i>
                    <select id="filterShift" class="bg-transparent text-sm font-semibold focus:outline-none text-slate-700 cursor-pointer">
                        <option value="Todos">Todos Turnos</option>
                        <option value="1">Turno 1</option>
                        <option value="2">Turno 2</option>
                        <option value="3">Turno 3</option>
                    </select>
                </div>
                <!-- Role Filter -->
                <div class="flex items-center gap-2 bg-slate-100 px-3 py-1.5 rounded-lg border border-slate-200">
                    <i data-lucide="users" class="w-4 h-4 text-slate-500"></i>
                    <select id="filterRole" class="bg-transparent text-sm font-semibold focus:outline-none text-slate-700 cursor-pointer">
                        <option value="Todos">Todas Áreas</option>
                        <option value="Mecânica">Mecânica</option>
                        <option value="Elétrica">Elétrica</option>
                        <option value="Automação">Automação</option>
                    </select>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="flex flex-1 overflow-hidden">
        
        <!-- Left: Gantt Chart -->
        <div class="flex-1 overflow-auto bg-slate-50 p-4 custom-scrollbar relative" id="mainContainer">
            
            <!-- Legend -->
            <div class="flex flex-wrap gap-4 mb-4 bg-white p-2 rounded-lg border border-slate-200 shadow-sm sticky left-0 z-30">
                <span class="text-xs font-bold text-slate-400 uppercase tracking-wider self-center mr-2">Legenda:</span>
                <div class="flex items-center gap-1.5">
                    <span class="w-3 h-3 rounded bg-emerald-500 shadow-sm"></span>
                    <span class="text-xs font-medium text-slate-700">Preventiva</span>
                </div>
                <div class="flex items-center gap-1.5">
                    <span class="w-3 h-3 rounded bg-orange-500 shadow-sm"></span>
                    <span class="text-xs font-medium text-slate-700">Corretiva</span>
                </div>
                <div class="flex items-center gap-1.5">
                    <span class="w-3 h-3 rounded bg-blue-500 shadow-sm"></span>
                    <span class="text-xs font-medium text-slate-700">Treino</span>
                </div>
                
                <div id="highlightIndicator" class="hidden flex items-center gap-1.5 ml-4 pulsing">
                    <span class="w-3 h-3 rounded-full bg-yellow-400 border border-yellow-600 shadow-sm"></span>
                    <span class="text-xs font-bold text-yellow-700" id="highlightText">Destacando ID #</span>
                    <button onclick="clearHighlight()" class="ml-1 text-slate-400 hover:text-red-500">
                        <i data-lucide="x" class="w-3 h-3"></i>
                    </button>
                </div>
            </div>

            <!-- Table -->
            <table class="w-full border-collapse min-w-[1000px] bg-white rounded-lg shadow-sm overflow-hidden mb-20">
                <thead class="bg-slate-100">
                    <tr id="headerRow">
                        <!-- Headers injected via JS -->
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <!-- Rows injected via JS -->
                </tbody>
            </table>
        </div>

        <!-- Right: Sidebar -->
        <div class="w-80 bg-white border-l border-slate-200 shadow-xl flex flex-col z-30 transition-all duration-300 h-full flex-none">
            
            <!-- Summary Section (Top) -->
            <div class="flex-none max-h-[50%] overflow-y-auto border-b border-slate-200 custom-scrollbar" id="summaryContainer">
                <!-- Content injected via JS based on selection -->
                <div class="p-6 text-center text-slate-400 bg-slate-50 h-full flex flex-col items-center justify-center min-h-[250px]">
                    <div class="bg-white p-4 rounded-full shadow-sm mb-4">
                        <i data-lucide="calendar" class="w-8 h-8 text-indigo-300"></i>
                    </div>
                    <h3 class="text-slate-600 font-bold mb-2">Painel de Resumo</h3>
                    <p class="text-sm">Clique em uma data no cabeçalho (ex: 24/12) para ver estatísticas.</p>
                </div>
            </div>

            <!-- Catalog Section (Bottom) -->
            <div class="flex-1 flex flex-col overflow-hidden bg-white">
                <div class="p-3 bg-slate-100 border-b border-slate-200 flex justify-between items-center sticky top-0 z-10">
                    <h4 class="font-bold text-xs text-slate-700 flex items-center gap-2">
                        <i data-lucide="search" class="w-3 h-3"></i>
                        Catálogo de Atividades
                    </h4>
                    <button id="clearHighlightBtn" onclick="clearHighlight()" class="hidden text-[10px] text-red-500 hover:underline">
                        Limpar
                    </button>
                </div>
                <div class="flex-1 overflow-y-auto p-2 custom-scrollbar space-y-2 bg-slate-50" id="catalogList">
                    <!-- Catalog items injected via JS -->
                </div>
            </div>
        </div>
    </div>

    <!-- Tooltip Element -->
    <div id="globalTooltip" class="fixed z-50 pointer-events-none hidden" style="transform: translate(-50%, -100%) translateY(-10px);">
        <div class="bg-slate-800 text-white p-3 rounded-xl shadow-2xl w-60 border border-slate-600 fade-in">
            <div class="flex justify-between items-center mb-2 border-b border-slate-700 pb-1">
                <span class="font-mono text-emerald-400 text-xs" id="ttId">ID #</span>
                <span class="text-[9px] px-1.5 rounded uppercase font-bold" id="ttClass"></span>
            </div>
            <div class="font-bold text-sm text-white mb-1 leading-tight" id="ttAsset"></div>
            <div class="text-xs text-slate-300 leading-snug" id="ttTask"></div>
            <div class="mt-2 text-[10px] text-slate-400 grid grid-cols-3 gap-2 border-t border-slate-700 pt-2">
                <div>Mec: <span class="text-white" id="ttMec"></span></div>
                <div>Ele: <span class="text-white" id="ttEle"></span></div>
                <div>Aut: <span class="text-white" id="ttAut"></span></div>
            </div>
            <!-- Arrow -->
            <div class="absolute top-full left-1/2 -translate-x-1/2 border-8 border-transparent border-t-slate-800"></div>
        </div>
    </div>

    <script>
        // --- DATA ---
        const ACTIVITIES = [
            { id: 1, asset: "EMBALADORA PROJPEACK L1", task: "Troca da esteira completa do túnel da embaladora.", class: "Crítico", mec: "32h", ele: "0", aut: "0" },
            { id: 2, asset: "509645 - DISP. ENCHIMENTO L2", task: "Preventiva Anual - Backlog.", class: "Backlog", mec: "4h", ele: "4h", aut: "0" },
            { id: 3, asset: "EMBALADORA PROJPACK L2", task: "Revisão geral e troca de Celeron.", class: "Normal", mec: "16h", ele: "0", aut: "0" },
            { id: 4, asset: "Teste funcional L2", task: "Verificação e troca de barramentos.", class: "Normal", mec: "0", ele: "8h", aut: "0" },
            { id: 5, asset: "Bomba de vácuo L2", task: "Realizar revisão nos sistema de vácuo.", class: "Normal", mec: "4h", ele: "0", aut: "0" },
            { id: 6, asset: "Teste motoca L2", task: "Revisão geral mecânica e elétrica.", class: "Normal", mec: "4h", ele: "0", aut: "0" },
            { id: 7, asset: "Elevador de topo L3", task: "Realizar verificação dos trilhos, verificar base.", class: "Crítico", mec: "8h", ele: "0", aut: "0" },
            { id: 8, asset: "510891 - CÉLULA ROBÓTICA L3", task: "Troca da válvula estabilizadora.", class: "Normal", mec: "4h", ele: "0", aut: "0" },
            { id: 9, asset: "Manipulador de base L3", task: "Verificar garras e conjunto mecânicos.", class: "Normal", mec: "4h", ele: "0", aut: "0" },
            { id: 10, asset: "Girolas L3", task: "Troca componente / Revisão conjunto.", class: "Crítico", mec: "8h", ele: "0", aut: "0" },
            { id: 11, asset: "EMBALADORA MÁQUINAPACK L3", task: "Realizar verificação dos componentes.", class: "Crítico", mec: "16h", ele: "0", aut: "0" },
            { id: 12, asset: "Parafusamento do pézinho L3", task: "Verificação de componentes e melhoria de lógica.", class: "Crítico", mec: "8h", ele: "0", aut: "0" },
            { id: 13, asset: "Mezanino L3", task: "Troca de correntes e revisão nos giradores.", class: "Crítico", mec: "40h", ele: "0", aut: "0" },
            { id: 14, asset: "510313/8 - TESTE FUNC. Nº 01 L4", task: "Preventiva Anual - Backlog.", class: "Backlog", mec: "2h", ele: "0", aut: "0" },
            { id: 15, asset: "510425 - TESTE FUNC. Nº 02 L4", task: "Preventiva Anual - Backlog.", class: "Backlog", mec: "2h", ele: "0", aut: "0" },
            { id: 16, asset: "510607 - TESTE FUNC. Nº 03 L4", task: "Preventiva Anual - Backlog.", class: "Backlog", mec: "2h", ele: "0", aut: "0" },
            { id: 17, asset: "510424 - TESTE FUNC. Nº 04 L4", task: "Preventiva Anual - Backlog.", class: "Backlog", mec: "2h", ele: "0", aut: "0" },
            { id: 18, asset: "Teste funcional (2 piores) L4", task: "Troca de correia p/ sist. de engrenagem.", class: "Melhoria", mec: "80h", ele: "0", aut: "0" },
            { id: 19, asset: "Esteira talisca pós transf. L4", task: "Verificar desgaste corrente, eixos, engren.", class: "Normal", mec: "32h", ele: "0", aut: "0" },
            { id: 20, asset: "Esteira de talisca 2 L4", task: "Revisão nos componentes mecânicos.", class: "Normal", mec: "32h", ele: "0", aut: "0" },
            { id: 21, asset: "Girador pré elevador L4", task: "Melhoria no sistema do girador.", class: "Melhoria", mec: "0", ele: "16h", aut: "0" },
            { id: 22, asset: "Elevador final L4", task: "Limpeza, verificação dos componentes.", class: "Normal", mec: "8h", ele: "0", aut: "0" },
            { id: 23, asset: "Célula parafusamento cavid. L4", task: "Verificar componentes elevadores.", class: "Normal", mec: "8h", ele: "0", aut: "0" },
            { id: 24, asset: "Esteira de montagem mesa L4", task: "Verificação dos elevadores e componentes.", class: "Normal", mec: "32h", ele: "0", aut: "0" },
            { id: 25, asset: "Time 1 - L4", task: "Individualizar botões emergência.", class: "Segurança", mec: "0", ele: "48h", aut: "8h" },
            { id: 26, asset: "Célula de colagem de painel L5", task: "Troca da base da garra do robô.", class: "Crítico", mec: "32h", ele: "4h", aut: "16h" },
            { id: 27, asset: "Esteira de roletes estanqueidade", task: "Seccionar esteira e realizar inst. stoppers", class: "Crítico", mec: "16h", ele: "4h", aut: "4h" },
            { id: 28, asset: "Projepack DPA (Pré Tunel)", task: "Verificar roletes da dorsal pré Tunel.", class: "Normal", mec: "16h", ele: "0", aut: "0" },
            { id: 29, asset: "IFA", task: "Troca das borrachas dos empilhadores.", class: "Normal", mec: "48h", ele: "0", aut: "0" },
            { id: 30, asset: "Esteira entrada DOCA manual", task: "Realizar tracionamento de roletes.", class: "Normal", mec: "16h", ele: "0", aut: "0" },
            { id: 31, asset: "Esteiras carregamento IFA", task: "Realizar lubrificação e verificação.", class: "Normal", mec: "16h", ele: "0", aut: "0" },
            { id: 32, asset: "Systec velha", task: "Verificação componentes dos pentes.", class: "Normal", mec: "64h", ele: "0", aut: "0" },
            { id: 33, asset: "510963/2 - ESTEIRA LIGAÇÃO L6", task: "Preventiva Anual - Backlog.", class: "Backlog", mec: "16h", ele: "0", aut: "0" },
        ];

        const SCHEDULE_DATES = [
            "20/12", "21/12", "22/12", "23/12", "24/12", "25/12", "26/12", "27/12", 
            "28/12", "29/12", "30/12", "31/12", "01/01", "02/01", "03/01", "04/01"
        ];

        const TEAM_DATA = [
            { name: "ELTON DE JESUS MARQUES ORTIZ", role: "Automação", shift: 1, schedule: ["", "Domingo", "2h. Treinamento", "", "Corretiva", "Natal", "", "", "Domingo", "", "", "Corretiva", "Ano Novo", "", "Testes/Enchimento", "Domingo"] },
            { name: "FLAVIO FERNANDO BORATO", role: "Automação", shift: 1, schedule: ["", "Domingo", "2h. Treinamento / Corretiva", "Corretiva", "Corretiva", "Natal", "Corretiva", "", "Domingo", "Corretiva", "Corretiva", "Corretiva", "Ano Novo", "Corretiva", "Testes/Enchimento", "Domingo"] },
            { name: "DIEGO APARECIDO DE LIMA", role: "Elétrica", shift: 1, schedule: ["", "Domingo", "2h. Treinamento / Corretiva", "Corretiva", "Corretiva", "Natal", "Corretiva", "", "Domingo", "Corretiva", "Corretiva", "Corretiva", "Ano Novo", "Corretiva", "Testes/Enchimento", "Domingo"] },
            { name: "MARCOS R. TORINI", role: "Elétrica", shift: 1, schedule: ["4", "Domingo", "2h. Treinamento", "", "Corretiva", "Natal", "", "", "Domingo", "", "", "Corretiva", "Ano Novo", "", "Testes/Enchimento", "Domingo"] },
            { name: "ANDERSON LUIZ SALA", role: "Mecânica", shift: 1, schedule: ["26", "Domingo", "2h. Treinamento / 26", "26", "Corretiva", "Natal", "26", "18", "Domingo", "18", "18", "Corretiva", "Ano Novo", "18", "Testes/Enchimento", "Domingo"] },
            { name: "LEONARDO GOMES", role: "Mecânica", shift: 1, schedule: ["3", "Domingo", "2h. Treinamento / 3", "29", "Corretiva", "Natal", "32", "11", "Domingo", "32", "32", "Corretiva", "Ano Novo", "30", "Testes/Enchimento", "Domingo"] },
            { name: "FERNANDO SEBASTIAO DE OLIVEIRA", role: "Mecânica", shift: 1, schedule: ["24", "Domingo", "2h. Treinamento / Corretiva", "Corretiva", "Corretiva", "Natal", "Corretiva", "", "Domingo", "Corretiva", "Corretiva", "Corretiva", "Ano Novo", "Corretiva", "Testes/Enchimento", "Domingo"] },
            { name: "RICARDO APARECIDO PAES", role: "Mecânica", shift: 1, schedule: ["24", "Domingo", "2h. Treinamento / 14 / 15 / 16 / 17", "29", "Corretiva", "Natal", "", "18", "Domingo", "18", "18", "Corretiva", "Ano Novo", "18", "Testes/Enchimento", "Domingo"] },
            { name: "SIDINEI DONIZETI MULLER", role: "Mecânica", shift: 1, schedule: ["3", "Domingo", "2h. Treinamento / 3", "5 / 6", "Corretiva", "Natal", "32", "11", "Domingo", "31", "31", "Corretiva", "Ano Novo", "30", "Testes/Enchimento", "Domingo"] },
            { name: "DOUGLAS LUIS FREIRE", role: "Automação", shift: 2, schedule: ["", "Domingo", "2h. Treinamento", "", "Corretiva", "Natal", "", "", "Domingo", "", "25", "Corretiva", "Ano Novo", "", "Testes/Enchimento", "Domingo"] },
            { name: "NILSON CARLOS MENDES", role: "Automação", shift: 2, schedule: ["", "Domingo", "2h. Treinamento", "", "Corretiva", "Natal", "", "", "Domingo", "", "", "Corretiva", "Ano Novo", "", "Testes/Enchimento", "Domingo"] },
            { name: "ALAN LUIZ MARQUES ORTIZ", role: "Elétrica", shift: 2, schedule: ["Férias", "Férias", "Férias", "Férias", "Férias", "Férias", "Férias", "Férias", "Férias", "Férias", "Férias", "Férias", "Férias", "Férias", "Férias", "Férias"] },
            { name: "MATHEUS VINICIUS LAPLACA CONTI", role: "Elétrica", shift: 2, schedule: ["27", "Domingo", "2h. Treinamento / Corretiva / 21", "Corretiva / 21", "Corretiva", "Natal", "Corretiva / 25", "Corretiva / 25", "Domingo", "Corretiva / 25", "Corretiva / 25", "Corretiva", "Ano Novo", "Corretiva", "Testes/Enchimento", "Domingo"] },
            { name: "RICARDO DE ALMEIDA DEMICO", role: "Elétrica", shift: 2, schedule: ["", "Domingo", "2h. Treinamento", "", "Corretiva", "Natal", "Corretiva / 25", "Corretiva / 25", "Domingo", "Corretiva / 25", "Corretiva / 25", "Corretiva", "Ano Novo", "", "Testes/Enchimento", "Domingo"] },
            { name: "HERCULES JOSE DOS SANTOS", role: "Mecânica", shift: 2, schedule: ["27", "Domingo", "2h. Treinamento/ Corretiva / 7", "Corretiva / 8", "Corretiva", "Natal", "Corretiva / 12", "29", "Domingo", "Corretiva / 29", "Corretiva / 29", "Corretiva", "Ano Novo", "Corretiva", "Testes/Enchimento", "Domingo"] },
            { name: "JORGE AUGUSTO RINALDI", role: "Mecânica", shift: 2, schedule: ["27", "Domingo", "2h. Treinamento / 33", "33", "Corretiva", "Natal", "19", "19", "Domingo", "20", "20", "Corretiva", "Ano Novo", "34", "Testes/Enchimento", "Domingo"] },
            { name: "FÁBIO TRINDADE", role: "Mecânica", shift: 2, schedule: ["33", "Domingo", "2h. Treinamento / 22", "9", "Corretiva", "Natal", "19", "19", "Domingo", "20", "20", "Corretiva", "Ano Novo", "34", "Testes/Enchimento", "Domingo"] },
            { name: "FABIO EUGENIO ROMERO", role: "Automação", shift: 3, schedule: ["Férias", "Férias", "Férias", "Férias", "Férias", "Férias", "Férias", "Férias", "Férias", "Férias", "Férias", "Corretiva", "Férias", "Férias", "Férias", "Férias"] },
            { name: "MARCIO RODRIGUES DA SILVA", role: "Elétrica", shift: 3, schedule: ["Folga", "", "2h. Treinamento", "", "Folga", "Natal", "", "Folga", "", "", "", "Folga", "Ano Novo", "", "Folga", ""] },
            { name: "SERGIO APARECIDO DA SILVA COSTA", role: "Elétrica", shift: 3, schedule: ["Folga", "", "2h. Treinamento", "", "Folga", "Natal", "", "Folga", "", "", "", "Folga", "Ano Novo", "", "Folga", ""] },
            { name: "GABRIEL FEITOSA ALANO", role: "Mecânica", shift: 3, schedule: ["Folga", "1", "2h. Treinamento / 1", "10", "Folga", "Natal", "11", "Folga", "13", "13", "13", "Folga", "Ano Novo", "30", "Folga", "Start"] },
            { name: "LUCIANO JOSE PINELI", role: "Mecânica", shift: 3, schedule: ["Folga", "1", "2h. Treinamento / 1", "23", "Folga", "Natal", "11", "Folga", "13", "13", "13", "Folga", "Ano Novo", "30", "Folga", "Start"] },
        ];

        const COLORS = {
            Preventive: "bg-emerald-500 text-white border-emerald-600 shadow-sm",
            Corrective: "bg-orange-500 text-white border-orange-600 shadow-sm",
            Training: "bg-blue-500 text-white border-blue-600 shadow-sm",
            Off: "bg-slate-200 text-slate-500 border-slate-300",
            Vacation: "bg-purple-100 text-purple-800 border-purple-200",
            Default: "bg-gray-100 text-gray-700",
        };

        // --- STATE ---
        let currentFilterRole = "Todos";
        let currentFilterShift = "Todos";
        let selectedDate = null;
        let highlightedActivity = null;

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            initFilters();
            renderGrid();
            renderCatalog();
        });

        function initFilters() {
            document.getElementById('filterShift').addEventListener('change', (e) => {
                currentFilterShift = e.target.value;
                renderGrid();
            });
            document.getElementById('filterRole').addEventListener('change', (e) => {
                currentFilterRole = e.target.value;
                renderGrid();
            });
        }

        // --- PARSING LOGIC ---
        function parseCell(content) {
            if (!content) return { type: 'empty', label: '' };
            if (content.includes("Férias")) return { type: 'vacation', label: 'Férias' };
            if (content.includes("Domingo") || content.includes("Natal") || content.includes("Ano Novo") || content.includes("Folga")) return { type: 'off', label: content };

            const hasTraining = content.toLowerCase().includes("treinamento");
            const hasCorrective = content.toLowerCase().includes("corretiva");

            const parts = content.split("/").map(p => p.trim());
            const validTasks = [];

            parts.forEach(p => {
                if (!p.toLowerCase().includes("treinamento") && !p.toLowerCase().includes("corretiva")) {
                    const potentialId = parseInt(p.replace(/\D/g, ''));
                    if (!isNaN(potentialId) && potentialId > 0 && potentialId < 100 && !p.toLowerCase().includes("h.")) {
                        validTasks.push(potentialId);
                    }
                }
            });

            if (validTasks.length > 0) {
                return { type: 'preventive', ids: validTasks, hasTraining, hasCorrective };
            }
            if (hasTraining) return { type: 'training', label: 'Treino' };
            if (hasCorrective) return { type: 'corrective', label: 'Corretiva' };

            return { type: 'other', label: content };
        }

        function getTaskDetails(ids) {
            return ids.map(id => ACTIVITIES.find(a => a.id === parseInt(id))).filter(Boolean);
        }

        // --- RENDERING ---

        function renderGrid() {
            // Render Headers
            const headerRow = document.getElementById('headerRow');
            let headerHTML = `<th class="sticky left-0 z-20 bg-slate-100 p-3 text-left border-b border-r border-slate-200 w-64 shadow-[2px_0_5px_-2px_rgba(0,0,0,0.1)]">
                <div class="flex items-center gap-2 text-slate-700 text-sm font-bold">Colaborador</div>
            </th>`;
            
            SCHEDULE_DATES.forEach(date => {
                const isSelected = selectedDate === date;
                const classes = isSelected 
                    ? 'bg-indigo-600 text-white shadow-inner scale-105' 
                    : 'text-slate-600 hover:bg-indigo-100 hover:text-indigo-700';
                
                headerHTML += `<th onclick="selectDate('${date}')" 
                    class="p-2 min-w-[70px] text-center border-b border-slate-200 text-sm font-bold transition-all cursor-pointer select-none ${classes}">
                    ${date}
                </th>`;
            });
            headerRow.innerHTML = headerHTML;

            // Render Body
            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = '';

            const filteredTeam = TEAM_DATA.filter(member => {
                const roleMatch = currentFilterRole === "Todos" || member.role === currentFilterRole;
                const shiftMatch = currentFilterShift === "Todos" || member.shift.toString() === currentFilterShift;
                return roleMatch && shiftMatch;
            });

            filteredTeam.forEach(member => {
                const row = document.createElement('tr');
                row.className = "hover:bg-slate-50 transition-colors group";
                
                // Name Cell
                let roleColorClass = '';
                if(member.role === 'Mecânica') roleColorClass = 'bg-orange-50 text-orange-700 border-orange-100';
                else if(member.role === 'Elétrica') roleColorClass = 'bg-yellow-50 text-yellow-700 border-yellow-100';
                else roleColorClass = 'bg-cyan-50 text-cyan-700 border-cyan-100';

                let rowHTML = `<td class="sticky left-0 z-10 bg-white group-hover:bg-slate-50 p-3 border-b border-r border-slate-200 shadow-[2px_0_5px_-2px_rgba(0,0,0,0.1)]">
                    <div class="font-semibold text-slate-700 text-sm md:text-base">${member.name}</div>
                    <div class="flex items-center gap-2 mt-1">
                        <span class="text-[10px] px-1.5 py-0.5 rounded uppercase tracking-wider font-bold border ${roleColorClass}">${member.role}</span>
                        <span class="text-[10px] text-slate-400 font-mono">T${member.shift}</span>
                    </div>
                </td>`;

                // Schedule Cells
                member.schedule.forEach((dayContent, dIdx) => {
                    const parsed = parseCell(dayContent);
                    const isSelectedDate = SCHEDULE_DATES[dIdx] === selectedDate;
                    const bgClass = isSelectedDate ? 'bg-indigo-50/50' : '';
                    
                    let cellContent = '';
                    
                    if (parsed.type === 'empty') {
                        cellContent = `<div class="w-full h-full"></div>`;
                    } else if (parsed.type === 'off' || parsed.type === 'vacation') {
                        const opacityClass = highlightedActivity ? 'opacity-30 grayscale' : '';
                        cellContent = `<div class="w-full h-full rounded flex items-center justify-center text-xs font-semibold select-none ${COLORS.Off} ${opacityClass}">${parsed.label}</div>`;
                    } else if (parsed.type === 'corrective') {
                        const opacityClass = highlightedActivity ? 'opacity-20 grayscale' : '';
                        cellContent = `<div class="w-full h-full rounded flex items-center justify-center text-xs font-bold shadow-sm ${COLORS.Corrective} ${opacityClass}">${parsed.label}</div>`;
                    } else if (parsed.type === 'training') {
                        const opacityClass = highlightedActivity ? 'opacity-20 grayscale' : '';
                        cellContent = `<div class="w-full h-full rounded flex items-center justify-center text-xs font-bold shadow-sm ${COLORS.Training} ${opacityClass}">${parsed.label}</div>`;
                    } else if (parsed.type === 'preventive') {
                        let innerHTML = '';
                        parsed.ids.forEach(id => {
                            const isGlobalHighlightActive = highlightedActivity !== null;
                            const isHighlighted = highlightedActivity === id;
                            let cellClass = "";
                            
                            if (isGlobalHighlightActive) {
                                if (isHighlighted) {
                                    cellClass = "bg-yellow-400 text-yellow-900 ring-4 ring-yellow-200 z-10 scale-110 border-yellow-500 font-extrabold shadow-lg"; 
                                } else {
                                    cellClass = "bg-slate-100 text-slate-300 border-slate-200 opacity-20 grayscale";
                                }
                            } else {
                                cellClass = COLORS.Preventive + " hover:ring-2 hover:ring-offset-1 hover:ring-emerald-400";
                            }

                            innerHTML += `<div onmouseenter="showTooltip(event, ${id})" onmouseleave="hideTooltip()"
                                class="w-full flex items-center justify-center py-1 rounded text-xs font-extrabold cursor-help shadow-sm transition-all relative mb-1 ${cellClass}">
                                ${id}
                            </div>`;
                        });
                        
                        // Dots for mixed content
                        if (parsed.hasCorrective) innerHTML += `<div class="w-2 h-2 rounded-full mx-0.5 inline-block ${highlightedActivity ? 'opacity-20' : COLORS.Corrective}"></div>`;
                        if (parsed.hasTraining) innerHTML += `<div class="w-2 h-2 rounded-full mx-0.5 inline-block ${highlightedActivity ? 'opacity-20' : COLORS.Training}"></div>`;

                        cellContent = `<div class="flex flex-wrap gap-1 content-start h-full overflow-y-auto custom-scrollbar">${innerHTML}</div>`;
                    } else {
                        const opacityClass = highlightedActivity ? 'opacity-20' : '';
                        cellContent = `<div class="w-full h-full rounded flex items-center justify-center text-xs text-center p-1 leading-tight font-medium bg-slate-100 text-slate-500 ${opacityClass}">${dayContent}</div>`;
                    }

                    rowHTML += `<td class="p-1 border-b border-slate-100 relative h-14 align-top ${bgClass}">${cellContent}</td>`;
                });

                row.innerHTML = rowHTML;
                tableBody.appendChild(row);
            });
        }

        function selectDate(date) {
            if (selectedDate === date) {
                selectedDate = null;
            } else {
                selectedDate = date;
            }
            renderGrid();
            renderSummary();
        }

        function renderSummary() {
            const container = document.getElementById('summaryContainer');
            
            if (!selectedDate) {
                container.innerHTML = `
                    <div class="p-6 text-center text-slate-400 bg-slate-50 h-full flex flex-col items-center justify-center min-h-[250px]">
                        <div class="bg-white p-4 rounded-full shadow-sm mb-4">
                            <i data-lucide="calendar" class="w-8 h-8 text-indigo-300"></i>
                        </div>
                        <h3 class="text-slate-600 font-bold mb-2">Painel de Resumo</h3>
                        <p class="text-sm">Clique em uma data no cabeçalho (ex: 24/12) para ver estatísticas.</p>
                    </div>`;
                lucide.createIcons();
                return;
            }

            // Calculate Stats
            const dateIndex = SCHEDULE_DATES.indexOf(selectedDate);
            const stats = { preventive: 0, corrective: 0, tasks: [] };
            
            // Note: Stats should reflect filters? Usually summary reflects reality, but let's stick to visible filtered data for consistency or all data? 
            // The React code used "filteredTeam", so we do the same.
            const filteredTeam = TEAM_DATA.filter(member => {
                const roleMatch = currentFilterRole === "Todos" || member.role === currentFilterRole;
                const shiftMatch = currentFilterShift === "Todos" || member.shift.toString() === currentFilterShift;
                return roleMatch && shiftMatch;
            });

            filteredTeam.forEach(member => {
                const cell = member.schedule[dateIndex];
                const parsed = parseCell(cell);
                if (parsed.type === 'preventive') {
                    stats.preventive++;
                    parsed.ids.forEach(id => {
                        const t = ACTIVITIES.find(a => a.id === id);
                        if (t && !stats.tasks.find(x => x.id === t.id)) stats.tasks.push(t);
                    });
                } else if (parsed.type === 'corrective') {
                    stats.corrective++;
                }
            });

            stats.tasks.sort((a, b) => a.id - b.id);

            let tasksHTML = '';
            if (stats.tasks.length > 0) {
                stats.tasks.forEach(task => {
                    const isHigh = highlightedActivity === task.id;
                    const borderClass = isHigh ? 'border-yellow-400 bg-yellow-50' : 'border-slate-100 bg-slate-50';
                    const tagClass = task.class === 'Crítico' ? 'bg-red-100 text-red-600' : 'bg-gray-200';
                    
                    tasksHTML += `
                    <li onclick="toggleHighlight(${task.id})" class="text-xs p-2 rounded border hover:bg-yellow-50 cursor-pointer transition-colors mb-2 ${borderClass}">
                        <div class="flex justify-between">
                            <strong class="text-slate-700">ID ${task.id}</strong>
                            <span class="text-[9px] px-1 rounded ${tagClass}">${task.class}</span>
                        </div>
                        <div class="text-slate-500 mt-1">${task.asset}</div>
                    </li>`;
                });
            } else {
                tasksHTML = '<p class="text-xs text-slate-400 italic">Nenhuma preventiva (ID) programada.</p>';
            }

            container.innerHTML = `
                <div class="p-4 bg-indigo-600 text-white sticky top-0 z-10">
                    <div class="flex justify-between items-center mb-1">
                        <h2 class="font-bold text-lg flex items-center gap-2">
                            <i data-lucide="calendar-days" class="w-5 h-5"></i>
                            ${selectedDate}
                        </h2>
                        <button onclick="selectDate('${selectedDate}')" class="hover:bg-indigo-500 p-1 rounded">
                            <i data-lucide="x" class="w-4 h-4"></i>
                        </button>
                    </div>
                    <p class="text-indigo-100 text-xs">Resumo do Dia</p>
                </div>
                <div class="p-4 space-y-6">
                    <div class="grid grid-cols-2 gap-3">
                        <div class="bg-emerald-50 p-3 rounded-lg border border-emerald-100">
                            <div class="text-emerald-800 text-xs font-bold uppercase">Preventiva</div>
                            <div class="text-2xl font-bold text-emerald-600">${stats.preventive}</div>
                        </div>
                        <div class="bg-orange-50 p-3 rounded-lg border border-orange-100">
                            <div class="text-orange-800 text-xs font-bold uppercase">Corretiva</div>
                            <div class="text-2xl font-bold text-orange-600">${stats.corrective}</div>
                        </div>
                    </div>
                    <div>
                        <h3 class="text-sm font-bold text-slate-800 mb-3 flex items-center gap-2 border-b pb-1">
                            <i data-lucide="check-circle" class="w-4 h-4 text-emerald-500"></i>
                            IDs em Atuação (Ord.)
                        </h3>
                        <ul class="space-y-0">
                            ${tasksHTML}
                        </ul>
                    </div>
                </div>`;
            
            lucide.createIcons();
        }

        function renderCatalog() {
            const list = document.getElementById('catalogList');
            let html = '';
            
            ACTIVITIES.forEach(a => {
                const isHigh = highlightedActivity === a.id;
                const containerClass = isHigh 
                    ? 'bg-yellow-100 border-yellow-400 shadow-md transform scale-105' 
                    : 'bg-white border-slate-200 hover:border-slate-300 hover:shadow-sm';
                const badgeClass = isHigh ? 'bg-yellow-400 text-yellow-900' : 'bg-emerald-50 text-emerald-700';
                const tagClass = a.class === 'Crítico' ? 'bg-red-100 text-red-700' : 'bg-gray-100 text-gray-500';

                html += `
                <div onclick="toggleHighlight(${a.id})" 
                    class="flex gap-2 text-[10px] p-2 rounded cursor-pointer transition-all border ${containerClass}">
                    <div class="flex flex-col items-center justify-center min-w-[30px] rounded p-1 ${badgeClass}">
                        <span class="font-bold text-xs">#${a.id}</span>
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="font-bold text-slate-700 truncate" title="${a.asset}">${a.asset}</div>
                        <div class="text-slate-500 truncate" title="${a.task}">${a.task}</div>
                        <div class="flex gap-2 mt-1">
                            <span class="px-1 rounded text-[9px] ${tagClass}">${a.class}</span>
                        </div>
                    </div>
                </div>`;
            });
            list.innerHTML = html;
        }

        function toggleHighlight(id) {
            if (highlightedActivity === id) {
                highlightedActivity = null;
            } else {
                highlightedActivity = id;
            }
            updateHighlightUI();
            renderGrid();
            renderCatalog();
            if(selectedDate) renderSummary(); // Update sidebar styling too
        }

        function clearHighlight() {
            highlightedActivity = null;
            updateHighlightUI();
            renderGrid();
            renderCatalog();
            if(selectedDate) renderSummary();
        }

        function updateHighlightUI() {
            const indicator = document.getElementById('highlightIndicator');
            const clearBtn = document.getElementById('clearHighlightBtn');
            const text = document.getElementById('highlightText');
            
            if (highlightedActivity) {
                indicator.classList.remove('hidden');
                clearBtn.classList.remove('hidden');
                text.textContent = `Destacando ID #${highlightedActivity}`;
            } else {
                indicator.classList.add('hidden');
                clearBtn.classList.add('hidden');
            }
        }

        // --- TOOLTIP LOGIC ---
        const tooltip = document.getElementById('globalTooltip');
        
        function showTooltip(e, id) {
            const task = ACTIVITIES.find(a => a.id === id);
            if(!task) return;

            document.getElementById('ttId').textContent = `ID #${task.id}`;
            const classEl = document.getElementById('ttClass');
            classEl.textContent = task.class;
            classEl.className = `text-[9px] px-1.5 rounded uppercase font-bold ${task.class === 'Crítico' ? 'bg-red-500' : 'bg-slate-600'}`;

            document.getElementById('ttAsset').textContent = task.asset;
            document.getElementById('ttTask').textContent = task.task;
            document.getElementById('ttMec').textContent = task.mec;
            document.getElementById('ttEle').textContent = task.ele;
            document.getElementById('ttAut').textContent = task.aut;

            const rect = e.currentTarget.getBoundingClientRect();
            tooltip.style.left = (rect.left + rect.width / 2) + 'px';
            tooltip.style.top = rect.top + 'px';
            tooltip.classList.remove('hidden');
        }

        function hideTooltip() {
            tooltip.classList.add('hidden');
        }

    </script>
</body>
</html>